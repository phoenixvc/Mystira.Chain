name: "[Test] Unit"

on:
  push:
    branches: [dev, main]
    paths:
      - "**/*.py"
      - "requirements*.txt"
      - "pyproject.toml"
      - ".github/workflows/test-unit.yml"
  pull_request:
    branches: [dev, main]
  workflow_dispatch:

concurrency:
  group: test-unit-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-cov pytest-asyncio

      - name: Run unit tests
        run: |
          # Run from tests/unit if exists, otherwise tests/
          if [ -d "tests/unit" ]; then
            TEST_PATH="tests/unit"
          elif [ -d "tests" ]; then
            TEST_PATH="tests"
          else
            echo "No tests directory found, skipping"
            exit 0
          fi
          pytest "$TEST_PATH" \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            -v || echo "No tests found or tests failed"
        continue-on-error: ${{ github.ref != 'refs/heads/main' }}

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/
          retention-days: 7

      - name: Coverage summary
        if: always()
        run: |
          if [ -f coverage.xml ]; then
            python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          coverage = float(root.attrib.get('line-rate', 0)) * 100
          print(f'Total coverage: {coverage:.2f}%')
          "
          fi
